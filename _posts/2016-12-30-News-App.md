---
layout: post
title:  "How to Build a Mobile Shiny App in an Hour"
desc: "Setting up "
keywords: "r,shiny,rstudio,mysql"
date: 2016-12-30
categories: [R,Shiny,EC2,AWS,MySQL]
tags: [R,Shiny,EC2,AWS,MySQL]
icon: fa-bookmark-o
---

**tl;dr**
Spin up a mobile-friendly Shiny app that stores data in an hour.

<iframe style="border:1px solid #000000;display: block;margin-left: auto;margin-right: auto;" width="450px" height="630px" align="center" src="https://jordanfarrer.shinyapps.io/fake_news" frameborder="1" allowfullscreen></iframe>

[Direct Link](https://jordanfarrer.shinyapps.io/fake_news) || [Github](https://github.com/jrfarrer/fake_news_app)
    

*[This project was inspired by a section of [Yihui Xie's](http://yihui.name/) [bookdown](https://bookdown.org/yihui/bookdown/web-pages-and-shiny-apps.html) that demonstrates how to embed Shiny Apps. His example uses [Joe Cheng's](https://github.com/jcheng5) [miniUI package](https://cran.r-project.org/web/packages/miniUI/index.html).]*

Sitting in the library for one of the first times during business school with the intention of studying for an economics final, I instead decided that building a shiny app was a better use of a Monday night.

I was working with a dataset from Buzzfeed on American's ability to distinguish accurate and inaccurate news in the wake of the 2016 presdiential election. This app was a means to show others just how difficult identifying fake news can be. This quick project is a testament to how RStudio's tools make creating custom web apps.

# Setup Shinyapps.io

Setting up shinyapps.io to host the app is the easiest part of the process.

(1) Setup an account on [shinyapps.io](shinyapps.io)

<img class="custom" src="{{site.img_path}}/fake_news_app/01.png" width="65%">

(2) Setup `rconnect` in your R enviornment.

```r
install.packages('rconnect')
library('rconnect')
```

On [shinyapps.io](shinyapps.io), go to **Account** â†’ **Tokens** then **+ Add Token**. Then click **Show** and copy this statement run in R.

<img class="custom" src="{{site.img_path}}/fake_news_app/02.png" width="65%">

# MySQL DB to Store Data

The hardest part of this process creating a place for persistent storage. This [summary of options](https://shiny.rstudio.com/articles/persistent-data-storage.html) by Dean Attali was extremely helpful in getting me started. Unfortunately I was unable to use the new [Amazon Lightsail](https://jrfarrer.github.io/r/2016/12/29/RStudio-Lightsail.html) VPS because only SSH connections are allowed, which would not be possible from the shinyapps.io server without its own key and port-forwarding.

(1) Spin up an EC2 instance, if you do not already have one.

From the [EC2 Dashboard](console.aws.amazon.com/ec2), click **Launch Instance**, select **Ubuntu**, and use the **t2.micro** which is part of the free tier. 

<img class="custom" src="{{site.img_path}}/fake_news_app/03.png" width="50%">

<img class="custom" src="{{site.img_path}}/fake_news_app/04.png" width="65%">

On the tab **6. Configure Security Group**, add a new rule for **MYSQL/Aurora**, which will add port 3306. Then copy `0.0.0.0/0` into the **Source** section. 

<img class="custom" src="{{site.img_path}}/fake_news_app/05.png" width="60%">

Then go to **Review and Launch** to finish the process. You will need to select a new or existing SSH key pair. To learn more about SSH key pairs, see this [article](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html). 

(2) SSH into the EC2 instance

Once the instance is running with the green ball next to it, copy the **Public DNS** and SSH into the machine.

<img class="custom" src="{{site.img_path}}/fake_news_app/06.png" width="65%">

```
ssh -i macbookair.pem ubuntu@ec2-XXXXXXXXX.compute-1.amazonaws.com
```

(3) Install MySQL Server

```
sudo apt-get update
sudo apt-get install mysql-server
```

After the second command you'll need to click **Y** and type in a password for the root user of MYSQL.

(4) Configure MySQL Installation. Run

```
sudo mysql_secure_installation
```

After typing the root password, say no by clicking any key (but **Y**) to the remaining questions.

(5) Test the server is running with the command:

```
service mysql status
```

(6) Access MySQL via the Shell

Run the following command and enter the password for the root MySQL user.

```
mysql -u root -p
```

(7) Run `SHOW DATABASES;` to see the default databases:

```mysql
SHOW DATABASES;
```

<img class="custom" src="{{site.img_path}}/fake_news_app/07.png" width="35%">

(8) We will create a database for our app called **fake_news**

```mysql
CREATE DATABASE fake_news;
```

Once it's created run to use this database:

```mysql
USE fake_news;
```

(9) The app will only require one simple table which is created with this command:

```mysql
CREATE TABLE responses (
    id INT NOT NULL PRIMARY KEY AUTO_INCREMENT, 
    email VARCHAR(254),
    domain VARCHAR(64),
    q_id INT, 
    response BOOLEAN
);
```

As a test, insert two records:

```mysql
INSERT INTO responses (email, domain, q_id, response) 
VALUES ("test","gmail.com", 2, TRUE), 
        ("test2","gmail.com", 1, FALSE);
SELECT * FROM responses;
```

<img class="custom" src="{{site.img_path}}/fake_news_app/08.png" width="35%">

Then delete them:

```mysql
DELETE FROM responses;
SELECT * FROM responses;
```

<img class="custom" src="{{site.img_path}}/fake_news_app/09.png" width="35%">

(10) Account Access for a User for the App

Here we will create a user that has *complete access* to the database. This tutorial is an example and obviously in a production environment you would do this differently.

```mysql
CREATE USER 'new_username'@'localhost' IDENTIFIED BY 'new_password';
CREATE USER 'new_username'@'%' IDENTIFIED BY 'new_password';

GRANT ALL ON *.* TO 'new_username'@'localhost';
GRANT ALL ON *.* TO 'new_username'@'%';

GRANT ALL PRIVILEGES ON *.* TO 'new_username'@'%' IDENTIFIED BY 'new_password' WITH GRANT OPTION;
```

If you are curious about the password requirements, check your environment variables that were set during configuration:

```mysql
SHOW VARIABLES LIKE 'validate_password%';
```

<img class="custom" src="{{site.img_path}}/fake_news_app/10.png" width="40%">

You also need to edit the `my.cnf` file to enable remote access. First quit MySQL with the `exit` command. Run the following command that opens `my.cnf` in the text editor vim.

```
sudo vim /etc/mysql/my.cnf
```

Hit `a` on the keyboard to enter insert mode, scroll down to right below the comment and paste the following in. 

```
[mysqld]
#
# * Basic Settings
#
user            = mysql
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
port            = 3306
basedir         = /usr
datadir         = /var/lib/mysql
tmpdir          = /tmp
lc-messages-dir = /usr/share/mysql
skip-external-locking
#
# Instead of skip-networking the default is now to listen only on
# localhost which is more compatible and is not less secure.
bind-address            = 0.0.0.0
```

<img class="custom" src="{{site.img_path}}/fake_news_app/11.png" width="50%">

Then tap `esc` then `:`, and type `wq!` and hit `enter`. Then run the following command to restart MySQL.

```
sudo /etc/init.d/mysql restart
```

The hard stuff is over!

# Create App

This part is relatively easy as we are making a simple Shiny app using the miniUI. In this app we have 3 tabs.

1. Tab 1: Users select whether they believe the news headline is Real / Fake and submit email address
2. Tab 2: Users view their results where mistakes are highlighted in red and the percent of others who have gotten that headline correct is shown
3. Tab 3: Users shown a "leaderboard" of correct responses based on domain. My idea was that this could be a competition among business schools.

To get this app running for yourself, clone the repo [https://github.com/jrfarrer/fake_news_app](https://github.com/jrfarrer/fake_news_app) and then modify the credentials in `credentials.R`.

```r
host <- "ec2-XXXXXXXXXXXX.compute-1.amazonaws.com"
user <- "fake_news"
password <- "XXXXXXXXXXXXXXX"
mailbox_layer <- "XXXXXXXXXXXXXXX"
```

You'll recognize the first 3 credentials in the image above as related to the MySQL serve we setup. The last credential relates to [mailboxlayer API](https://mailboxlayer.com/), which is an email verification service. I use this to check whether the email address is a real email address. It is ease to signup for free and get an API key that you can paste in. With each call to the mailboxlayer API, you receive a score on the likelihood the provided address is legitimate. In the `app.R` I set a threshold of 0.65 and also use the domain returned to check that it is a `.edu` address to better support the leaderboard objective.

To test the app, change the comment of the last two lines to

```r
#shinyApp(ui, server)
runGadget(shinyApp(ui, server), viewer = paneViewer())
```

highlight all and run (do not click `Run App`). The app should appear in the RStudio Viewer:

<img class="custom" src="{{site.img_path}}/fake_news_app/12.png" width="50%">

If this works, you are ready to deploy.

# Deploy

Luckily this part is quite straightforward.

Run the deployApp command

```r
rsconnect::deployApp()
```

<img class="custom" src="{{site.img_path}}/fake_news_app/13.png" width="60%">

The first time this will take a while as all package dependencies are built. When you make a change, simply rerun 

```r
deployApp()
```

